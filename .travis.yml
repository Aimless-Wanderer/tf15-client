language: cpp
compiler: gcc
git:
  submodules: true
jobs:
  include:
    - stage: build
      name: "Build for Linux"
      cache: ccache
      os: linux
      dist: xenial
      addons:
        apt:
          packages:
            - gcc-multilib
            - g++-multilib
            - p7zip-full
      before_script:
        - export ARCH=i686
      script:
        - ./waf -T debug configure build
      before_deploy:
        - mv */*/*.so .
        - 7z a -t7z tf15-client-linux.7z -m0=lzma2 -mx=9 -mfb=64 -md=32m -ms=on *.so
      deploy:
        provider: releases
        api_key: $GITHUB_OAUTH
        file: tf15-client-linux-i386.7z
        skip_cleanup: true
        overwrite: true
    - stage: build
      name: "Build for Windows"
      cache: ccache
      os: windows
      script:
        - ./waf -T debug configure build
      before_deploy:
        - mv */*/*.dll */*/*.pdb .
        - 7z a -t7z tf15-client-win32.7z -m0=lzma2 -mx=9 -mfb=64 -md=32m -ms=on *.dll *.pdb
      deploy:
        provider: releases
        api_key: $GITHUB_TOKEN
        file: tf15-client-win32-msvc.7z
        skip_cleanup: true
        overwrite: true